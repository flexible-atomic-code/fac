/*
 *   FAC - Flexible Atomic Code
 *   Copyright (C) 2001-2015 Ming Feng Gu
 * 
 *   This program is free software: you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *   (at your option) any later version.
 * 
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 *   GNU General Public License for more details.
 * 
 *   You should have received a copy of the GNU General Public License
 *   along with this program. If not, see <http://www.gnu.org/licenses/>.
 */

#include "coulomb.h"
#include "interpolation.h"
#include "cf77.h"

/*************************************************************
  Implementation for module "coulomb". 
  This module calculates quatities related to the H-like ions.

  Author: M. F. Gu, mfgu@stanford.edu
**************************************************************/

static char *rcsid="$Id: coulomb.c,v 1.31 2006/08/04 07:43:53 mfgu Exp $";
#if __GNUC__ == 2
#define USE(var) static void * use_##var = (&use_##var, (void *) &var) 
USE (rcsid);
#endif

static int n_hydrogenic;
static int kl_hydrogenic;
static int n_hydrogenic_max;
static int kl_hydrogenic_max;
static ARRAY *dipole_array;

static int _cbindex[CBMULT][CBMULT+1];
static double *_cb[MAXNE][MAXNTE][MAXNE][MAXNCB];

void SetHydrogenicNL(int n, int kl, int nm, int klm) {
  if (n > 0) n_hydrogenic = n;
  else n_hydrogenic = NHYDROGEN;
  if (kl >= 0) kl_hydrogenic = kl;
  else kl_hydrogenic = LHYDROGEN;
  if (nm > 0) n_hydrogenic_max = nm;
  else n_hydrogenic_max = NHYDROGENMAX;
  if (klm >= 0) kl_hydrogenic_max = klm;
  else kl_hydrogenic_max = LHYDROGENMAX;
  if (n_hydrogenic_max < n_hydrogenic) 
    n_hydrogenic_max = n_hydrogenic;
  if (kl_hydrogenic_max < kl_hydrogenic) 
    kl_hydrogenic_max = kl_hydrogenic;
}

void GetHydrogenicNL(int *n, int *kl, int *nm, int *klm) {
  if (n) *n = n_hydrogenic;
  if (kl) *kl = kl_hydrogenic;
  if (nm) *nm = n_hydrogenic_max;
  if (klm) *klm = kl_hydrogenic_max;
}

double HydrogenicDipole(double z, int n0, int kl0, int n1, int kl1) {
  double anc, am;
  double z0 = 1.0;
  int nmax = 512;
  double ac[1024];
  static int iopt = 2;
  double **qk, *t;
  int n, i;
  
  if (n1 > 512) return 0.0;
  if (n0 >= n1) {
    return 0.0;
  } 
  if (kl1 != kl0 + 1 && kl1 != kl0 - 1) {
    return 0.0;
  }
  qk = (double **) ArraySet(dipole_array, n1, NULL, InitPointerData);
  if (*qk == NULL) {
    *qk = (double *) malloc(sizeof(double)*n1*(n1-1));
    t = *qk;
    am = 100.0;
    if (iopt == 2) {
      ACOFZ1(z0, am, nmax, n0, ac, &anc, n1, iopt);
    }
    iopt = 1;
    for (n = 1; n < n1; n++) {
      ACOFZ1(z0, am, n1, n, ac, &anc, n1, iopt);
      for (i = 0; i < n; i++) {
	*(t++) = ac[i];
      }
      for (i = 0; i < n; i++) {
	*(t++) = ac[i+n1];
      }
    }
  }

  t = (*qk) + n0*(n0-1);
  if (kl1 == kl0 - 1) {
    return t[kl1]/z;
  } else {
    return t[n0 + kl0]/z;
  }
}

double TRRateHydrogenic(double z, int n0, int kl0, int n1, int kl1, int s) {
  double c, g, al;
  double factor, e2, r;

  c = HydrogenicDipole(z, n0, kl0, n1, kl1);
  if (c == 0) return c;
  e2 = z*z*(1.0/(n0*n0) - 1.0/(n1*n1));
  al = (double) Max(kl0, kl1);
  if (s == 0) {
    factor = 2.6775015E9*e2*e2*e2;
    r = (al/(2.0*kl1 + 1.0))*c*c*factor;
  } else if (s == 1) {
    factor = 2.6775015E9*e2;
    r = (4.0*al/(2.0*kl1 + 1.0))*c*c*factor;
    c = 1.0/(2.0*pow(FINE_STRUCTURE_CONST, 3.0));
    r /= RATE_AU;
    g = 2.0*(2.0*kl1+1.0);
    r *= g*c;
  } else {
    r = c;
  }
  return r;
}

double HydrogenicExpectation(double z, int m, int n, int kl) {
  double r, n2, k, e;
  
  k = kl*(kl+1.0);
  n2 = n*n;
  e = -0.5*z*z/n2;
  r = 0.0;
  
  switch (m) {
  case -3:
    r = 2*z*z/(n2*n*(2.0*kl+1.0));
    r *= z/k; 
    break;
  case -2:
    r = 2*z*z/(n2*n*(2.0*kl+1.0));
    break;
  case -1:
    r = z/n2;
    break;
  case 0:
    r = 1.0;
    break;
  case 1:
    r = (3.0*n2 - k)/(2.0*z);
    break;
  case 2:
    r = (n2/(2*z*z))*(5*n2 + 1.0 - 3.0*k);
    break;
  case 3:
    r = (n2/(8*z*z*z))*(5*n2*(7*n2+5)+4*k*(k-10*n2-2));
    break;
  default:
    break;
  }

  return r;
}

static double _zd[14] = {1.0, 10.0, 20.0, 30.0, 40.0, 50.0, 
			 60.0, 70.0, 80.0, 90.0, 100.0, 110, 115, 120};
static double _sd[19][14] = {
    {10.3168,4.6540,3.2460,2.5519,
     2.1351,1.8644,1.6838,1.5675,
     1.5032,1.4880,1.5317,1.6614,1.7811,1.9708},          /*1s+*/
    {10.5468,  4.8930,   3.5063,   2.8391, 
     2.4550,  2.2244,   2.0948,   2.0435,
     2.0650,  2.1690,   2.3870,   2.7980,3.1330,3.6437},  /*2s+*/
    {-0.1264, -0.1145,  -0.0922,  -0.0641,
     -0.0308,  0.0082,   0.0549,   0.1129,
     0.1884,  0.2934,   0.4530,   0.7250, 0.9468, 1.2926},      /*2p-*/
    { 0.1235,  0.1303,   0.1436,   0.1604,
      0.1794,  0.1999,   0.2215,   0.2440,
      0.2671,  0.2906,   0.3141,   0.3367, 0.3473, 0.3566},      /*2p+*/
    {10.5000,  4.9524,   3.5633,   2.8940,
      2.5083,  2.2757,   2.1431,   2.0874,
     2.1018,  2.1935,   2.3897,   2.7609, 3.0659, 3.5219},      /*3s+*/
    {-0.1300, -0.1021,  -0.0760,  -0.0430,
      0.0041,  0.0414,   0.0956,   0.1623,
     0.2483,  0.3660,   0.5408,   0.8322, 1.0668, 1.4219},      /*3p-*/
    { 0.1250,  0.1421,   0.1572,   0.1761,
      0.1977,  0.2214,   0.2470,   0.2745,
      0.3038,  0.3350,   0.3679,   0.4020, 0.4189, 0.4348},      /*3p+*/
    {-0.0440, -0.0428,  -0.0420,  -0.0410,
     -0.0396, -0.0378,  -0.0353,  -0.0321,
     -0.0279, -0.0225,  -0.0154,  -0.0062, -0.000699, 0.005518},      /*3d-*/
    { 0.0400,   0.0408,  0.0417,   0.0432,
      0.0452,   0.0475,  0.0503,   0.0536,
      0.0572,   0.0612,  0.0654,   0.0699, 0.07222, 0.07453},      /*3d+*/
    {10.5000,  4.9749,   3.5834,   2.9110,
      2.5215,  2.2842,   2.1455,   2.0814,
     2.0840,  2.1582,   2.3262,   2.6484, 2.9131, 3.3080},      /*4s+*/ 
    {-0.1200, -0.0963,  -0.0690,  -0.0344,              
      0.0064,  0.0538,   0.1098,   0.1780,              
     0.2649,  0.3819,   0.5525,   0.8311, 1.0513, 1.3798},      /*4p-*/ 
    { 0.1250,  0.1477,   0.1630,   0.1827,              
      0.2052,  0.2299,   0.2568,   0.2858,              
      0.3170,  0.3507,   0.3868,   0.4247, 0.4436, 0.4617},      /*4p+*/ 
    {-0.0410, -0.0403,  -0.0399,  -0.0387,              
     -0.0371, -0.0348,  -0.0317,  -0.0276,              
     -0.0222, -0.0149,  -0.0053,   0.0074, 0.01507, 0.02376},      /*4d-*/ 
    { 0.0424,  0.0428,   0.0440,    0.0457,             
      0.0479,  0.0507,   0.0541,    0.0580,             
      0.0624,  0.0673,   0.0727,    0.0783, 0.08122, 0.08413},     /*4d+*/ 
    {10.5000,  4.9858,   3.5923,   2.9173,     
      2.5246,  2.2833,   2.1395,   2.0686,
     2.0619,  2.1225,   2.2696,   2.5566, 2.7933, 3.1464},      /*5s+*/ 
    {-0.1200, -0.0933,  -0.0652,  -0.0299,               
      0.0116,  0.0597,   0.1161,   0.1843,               
     0.2703,  0.3848,   0.5497,   0.8150, 1.0222, 1.3285},      /*5p-*/ 
    { 0.1300,  0.1502,   0.1662,   0.1861,               
      0.2089,  0.2341,   0.2614,   0.2910,               
      0.3229,  0.3574,   0.3946,   0.4338, 0.4534, 0.4722},      /*5p+*/ 
    {-0.0405, -0.0396,  -0.0387,  -0.0374,               
     -0.0356, -0.0331,  -0.0297,  -0.0252,               
     -0.0190, -0.0108,   0.0001,   0.0145, 0.02325, 0.03316},      /*5d-*/ 
    { 0.0436, 0.0440,    0.0452,   0.0470,               
      0.0494, 0.0524,    0.0560,   0.0602,               
      0.0650, 0.0704,    0.0762,   0.0824, 0.0855, 0.08867}};     /*5d+*/ 
static int _nd[5] = {0, 1, 4, 9, 14};

static double _qed_za[112] = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 115, 120};
static double _qed_rrms[112]={  0.87750,  1.67550,  2.44400,  2.51900,  2.40600,  2.47020,  2.55820,  2.69910,  2.89760,  3.00550,  2.99360,  3.05700,  3.06100,  3.12240,  3.18890,  3.26110,  3.36500,  3.42740,  3.43490,  3.47760,  3.54590,  3.59210,  3.60020,  3.64520,  3.70570,  3.73770,  3.78750,  3.77570,  3.88230,  3.92830,  3.99730,  4.07420,  4.09680,  4.14000,  4.16290,  4.18840,  4.20360,  4.22400,  4.24300,  4.26940,  4.32400,  4.40910,  4.42400,  4.48090,  4.49450,  4.53180,  4.54540,  4.59440,  4.61560,  4.65190,  4.68020,  4.74230,  4.75000,  4.78590,  4.80410,  4.83780,  4.85500,  4.87710,  4.89190,  4.91230,  4.96200,  5.08190,  5.11150,  5.15690,  5.06000,  5.20700,  5.20200,  5.25160,  5.22560,  5.31080,  5.37000,  5.34700,  5.35070,  5.36580,  5.37000,  5.41260,  5.40000,  5.43070,  5.43710,  5.46480,  5.47590,  5.50120,  5.52110,  5.52700,  5.53900,  5.69100,  5.69500,  5.72100,  5.67000,  5.78500,  5.70000,  5.85710,  5.74400,  5.89500,  5.90480,  5.85600,  5.81500,  5.85000,  5.85000,  5.85700,  5.89200,  5.89900,  5.91900,  5.91300,  5.91900,  5.94700,  5.93300,  5.96700,  5.96000,  5.99300,  6.08800,  6.17500};
static double _qed_se0[4][112]={{ 10.31679,  8.52833,  7.50450,  6.79282,  6.25163,  5.81789,  5.45803,  5.15203,  4.88700,  4.65416,  4.44724,  4.26164,  4.09384,  3.94115,  3.80141,  3.67290,  3.55420,  3.44415,  3.34177,  3.24626,  3.15689,  3.07308,  2.99430,  2.92011,  2.85010,  2.78394,  2.72131,  2.66193,  2.60557,  2.55201,  2.50106,  2.45253,  2.40627,  2.36213,  2.31998,  2.27970,  2.24118,  2.20432,  2.16903,  2.13523,  2.10283,  2.07177,  2.04197,  2.01338,  1.98594,  1.95960,  1.93431,  1.91002,  1.88669,  1.86427,  1.84275,  1.82207,  1.80221,  1.78314,  1.76483,  1.74726,  1.73039,  1.71421,  1.69870,  1.68384,  1.66960,  1.65598,  1.64295,  1.63051,  1.61864,  1.60732,  1.59655,  1.58631,  1.57660,  1.56741,  1.55873,  1.55055,  1.54287,  1.53568,  1.52898,  1.52277,  1.51705,  1.51181,  1.50705,  1.50278,  1.49899,  1.49569,  1.49288,  1.49057,  1.48876,  1.48746,  1.48668,  1.48643,  1.48671,  1.48754,  1.48894,  1.49092,  1.49349,  1.49668,  1.50051,  1.50501,  1.51019,  1.51609,  1.52275,  1.53020,  1.53848,  1.54764,  1.55772,  1.56879,  1.58091,  1.59415,  1.60859,  1.62432,  1.64144,  1.66006,  1.78109,  1.97085},{ 10.54683,  8.75887,  7.73578,  7.02500,  6.48486,  6.05231,  5.69376,  5.38917,  5.12566,  4.89442,  4.68919,  4.50535,  4.33940,  4.18863,  4.05088,  3.92442,  3.80784,  3.69998,  3.59985,  3.50665,  3.41966,  3.33828,  3.26199,  3.19035,  3.12296,  3.05947,  2.99956,  2.94298,  2.88948,  2.83884,  2.79086,  2.74537,  2.70222,  2.66125,  2.62234,  2.58536,  2.55022,  2.51681,  2.48504,  2.45483,  2.42610,  2.39878,  2.37281,  2.34813,  2.32469,  2.30243,  2.28130,  2.26127,  2.24230,  2.22434,  2.20736,  2.19134,  2.17625,  2.16205,  2.14873,  2.13626,  2.12462,  2.11379,  2.10376,  2.09452,  2.08604,  2.07832,  2.07135,  2.06511,  2.05961,  2.05483,  2.05077,  2.04743,  2.04480,  2.04289,  2.04169,  2.04121,  2.04145,  2.04242,  2.04411,  2.04655,  2.04974,  2.05368,  2.05840,  2.06391,  2.07021,  2.07735,  2.08532,  2.09415,  2.10388,  2.11452,  2.12610,  2.13867,  2.15225,  2.16688,  2.18262,  2.19949,  2.21757,  2.23690,  2.25754,  2.27957,  2.30305,  2.32808,  2.35473,  2.38312,  2.41335,  2.44554,  2.47982,  2.51635,  2.55530,  2.59684,  2.64119,  2.68859,  2.73929,  2.79359,  3.13305,  3.64375},{ -0.12640, -0.12582, -0.12499, -0.12397, -0.12277, -0.12143, -0.11995, -0.11835, -0.11665, -0.11484, -0.11295, -0.11096, -0.10890, -0.10676, -0.10455, -0.10227, -0.09992, -0.09751, -0.09504, -0.09252, -0.08993, -0.08730, -0.08461, -0.08186, -0.07907, -0.07622, -0.07332, -0.07037, -0.06738, -0.06433, -0.06123, -0.05809, -0.05489, -0.05164, -0.04834, -0.04499, -0.04159, -0.03813, -0.03462, -0.03105, -0.02743, -0.02374, -0.02000, -0.01620, -0.01233, -0.00840, -0.00440, -0.00034,  0.00380,  0.00801,  0.01230,  0.01666,  0.02111,  0.02564,  0.03025,  0.03496,  0.03976,  0.04466,  0.04966,  0.05476,  0.05998,  0.06531,  0.07076,  0.07633,  0.08204,  0.08788,  0.09386,  0.09999,  0.10628,  0.11273,  0.11936,  0.12616,  0.13315,  0.14033,  0.14773,  0.15534,  0.16319,  0.17127,  0.17961,  0.18823,  0.19712,  0.20632,  0.21583,  0.22568,  0.23589,  0.24647,  0.25745,  0.26886,  0.28073,  0.29307,  0.30593,  0.31934,  0.33334,  0.34796,  0.36325,  0.37927,  0.39606,  0.41369,  0.43221,  0.45171,  0.47226,  0.49395,  0.51687,  0.54114,  0.56688,  0.59423,  0.62334,  0.65438,  0.68756,  0.72310,  0.94679,  1.29265},{  0.12350,  0.12384,  0.12432,  0.12492,  0.12562,  0.12643,  0.12731,  0.12827,  0.12929,  0.13036,  0.13149,  0.13269,  0.13393,  0.13523,  0.13657,  0.13794,  0.13936,  0.14082,  0.14231,  0.14384,  0.14539,  0.14698,  0.14860,  0.15024,  0.15192,  0.15362,  0.15534,  0.15709,  0.15886,  0.16065,  0.16246,  0.16429,  0.16614,  0.16801,  0.16990,  0.17181,  0.17373,  0.17567,  0.17762,  0.17960,  0.18158,  0.18358,  0.18559,  0.18762,  0.18966,  0.19172,  0.19378,  0.19586,  0.19795,  0.20005,  0.20217,  0.20429,  0.20643,  0.20857,  0.21072,  0.21289,  0.21506,  0.21725,  0.21944,  0.22164,  0.22385,  0.22607,  0.22830,  0.23053,  0.23277,  0.23502,  0.23728,  0.23954,  0.24182,  0.24409,  0.24638,  0.24867,  0.25096,  0.25327,  0.25557,  0.25789,  0.26020,  0.26253,  0.26485,  0.26719,  0.26952,  0.27186,  0.27420,  0.27655,  0.27890,  0.28125,  0.28360,  0.28596,  0.28831,  0.29067,  0.29302,  0.29538,  0.29773,  0.30009,  0.30244,  0.30479,  0.30713,  0.30947,  0.31181,  0.31413,  0.31645,  0.31877,  0.32107,  0.32336,  0.32564,  0.32790,  0.33015,  0.33238,  0.33459,  0.33678,  0.34727,  0.38186}};
static double _qed_se1[4][112]={{  0.00000, -0.00000, -0.00001, -0.00001, -0.00001, -0.00001, -0.00002, -0.00002, -0.00003, -0.00003, -0.00004, -0.00004, -0.00005, -0.00005, -0.00006, -0.00007, -0.00008, -0.00009, -0.00009, -0.00010, -0.00011, -0.00013, -0.00013, -0.00015, -0.00016, -0.00017, -0.00019, -0.00020, -0.00022, -0.00024, -0.00026, -0.00029, -0.00030, -0.00033, -0.00035, -0.00038, -0.00040, -0.00042, -0.00045, -0.00048, -0.00052, -0.00057, -0.00060, -0.00065, -0.00069, -0.00074, -0.00078, -0.00084, -0.00090, -0.00096, -0.00102, -0.00111, -0.00117, -0.00125, -0.00133, -0.00143, -0.00152, -0.00162, -0.00172, -0.00183, -0.00197, -0.00218, -0.00233, -0.00250, -0.00256, -0.00285, -0.00302, -0.00325, -0.00342, -0.00373, -0.00404, -0.00426, -0.00453, -0.00484, -0.00516, -0.00557, -0.00591, -0.00635, -0.00678, -0.00729, -0.00781, -0.00840, -0.00904, -0.00968, -0.01040, -0.01161, -0.01245, -0.01343, -0.01421, -0.01571, -0.01648, -0.01841, -0.01927, -0.02154, -0.02329, -0.02485, -0.02659, -0.02900, -0.03139, -0.03407, -0.03723, -0.04047, -0.04417, -0.04802, -0.05232, -0.05742, -0.06252, -0.06882, -0.07523, -0.08302, -0.13702, -0.23734},{  0.00000, -0.00000, -0.00001, -0.00001, -0.00001, -0.00001, -0.00002, -0.00002, -0.00003, -0.00003, -0.00004, -0.00004, -0.00005, -0.00005, -0.00006, -0.00007, -0.00008, -0.00009, -0.00009, -0.00010, -0.00011, -0.00013, -0.00013, -0.00015, -0.00016, -0.00017, -0.00019, -0.00020, -0.00022, -0.00024, -0.00027, -0.00029, -0.00032, -0.00034, -0.00036, -0.00039, -0.00042, -0.00045, -0.00048, -0.00051, -0.00055, -0.00061, -0.00065, -0.00071, -0.00075, -0.00081, -0.00086, -0.00093, -0.00100, -0.00107, -0.00115, -0.00125, -0.00134, -0.00144, -0.00154, -0.00166, -0.00177, -0.00190, -0.00204, -0.00218, -0.00237, -0.00263, -0.00284, -0.00307, -0.00317, -0.00355, -0.00379, -0.00411, -0.00436, -0.00479, -0.00523, -0.00556, -0.00597, -0.00643, -0.00691, -0.00751, -0.00805, -0.00872, -0.00940, -0.01020, -0.01103, -0.01198, -0.01300, -0.01406, -0.01524, -0.01719, -0.01861, -0.02029, -0.02168, -0.02421, -0.02567, -0.02897, -0.03065, -0.03462, -0.03781, -0.04079, -0.04412, -0.04862, -0.05322, -0.05842, -0.06462, -0.07102, -0.07842, -0.08622, -0.09512, -0.10562, -0.11632, -0.12963, -0.14343, -0.16013, -0.28113, -0.51817},{  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00001, -0.00001, -0.00001, -0.00001, -0.00001, -0.00001, -0.00002, -0.00002, -0.00002, -0.00002, -0.00003, -0.00003, -0.00003, -0.00004, -0.00005, -0.00005, -0.00006, -0.00007, -0.00008, -0.00009, -0.00010, -0.00012, -0.00013, -0.00015, -0.00017, -0.00020, -0.00022, -0.00024, -0.00027, -0.00031, -0.00035, -0.00039, -0.00044, -0.00049, -0.00056, -0.00062, -0.00070, -0.00079, -0.00089, -0.00100, -0.00118, -0.00132, -0.00150, -0.00166, -0.00192, -0.00211, -0.00247, -0.00271, -0.00318, -0.00360, -0.00403, -0.00452, -0.00517, -0.00588, -0.00670, -0.00768, -0.00877, -0.01005, -0.01148, -0.01317, -0.01520, -0.01741, -0.02019, -0.02326, -0.02705, -0.05872, -0.13674},{  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00001, -0.00001, -0.00001, -0.00001, -0.00001, -0.00001, -0.00001, -0.00001, -0.00002, -0.00002, -0.00002, -0.00002, -0.00003, -0.00003, -0.00003, -0.00003, -0.00004, -0.00004, -0.00005, -0.00005, -0.00006, -0.00006, -0.00007, -0.00008, -0.00008, -0.00009, -0.00010, -0.00011, -0.00012, -0.00013, -0.00014, -0.00015, -0.00017, -0.00018, -0.00020, -0.00022, -0.00024, -0.00026, -0.00029, -0.00030, -0.00034, -0.00035, -0.00039, -0.00043, -0.00045, -0.00048, -0.00052, -0.00056, -0.00060, -0.00065, -0.00070, -0.00075, -0.00080, -0.00086, -0.00092, -0.00098, -0.00105, -0.00111, -0.00118, -0.00160, -0.00184}};
static double _qed_ex0[4][112]={{ -0.01479, -0.00266, -0.00134, -0.00112, -0.00107, -0.00117, -0.00123, -0.00132, -0.00141, -0.00155, -0.00165, -0.00178, -0.00189, -0.00200, -0.00211, -0.00221, -0.00231, -0.00239, -0.00249, -0.00258, -0.00265, -0.00272, -0.00280, -0.00287, -0.00294, -0.00301, -0.00306, -0.00312, -0.00318, -0.00323, -0.00329, -0.00334, -0.00339, -0.00343, -0.00348, -0.00349, -0.00356, -0.00361, -0.00365, -0.00369, -0.00373, -0.00377, -0.00381, -0.00381, -0.00388, -0.00392, -0.00396, -0.00396, -0.00403, -0.00407, -0.00410, -0.00414, -0.00418, -0.00421, -0.00425, -0.00429, -0.00432, -0.00436, -0.00440, -0.00435, -0.00447, -0.00451, -0.00456, -0.00460, -0.00463, -0.00467, -0.00472, -0.00476, -0.00480, -0.00485, -0.00491, -0.00495, -0.00502, -0.00506, -0.00511, -0.00517, -0.00524, -0.00517, -0.00539, -0.00522, -0.00552, -0.00533, -0.00568, -0.00578, -0.00581, -0.00587, -0.00600, -0.00606, -0.00620, -0.00613, -0.00645, -0.00658, -0.00675, -0.00687, -0.00702, -0.00711, -0.00727, -0.00736, -0.00752, -0.00780, -0.00798, -0.00818, -0.00837, -0.00867, -0.00887, -0.00908, -0.00940, -0.00964, -0.00998, -0.01022, 0.01022, 0.01022},{ -0.01516, -0.00274, -0.00137, -0.00113, -0.00107, -0.00116, -0.00122, -0.00130, -0.00139, -0.00153, -0.00162, -0.00176, -0.00187, -0.00199, -0.00209, -0.00221, -0.00231, -0.00240, -0.00250, -0.00260, -0.00269, -0.00276, -0.00285, -0.00294, -0.00301, -0.00309, -0.00316, -0.00323, -0.00330, -0.00337, -0.00343, -0.00349, -0.00356, -0.00362, -0.00368, -0.00371, -0.00379, -0.00385, -0.00391, -0.00396, -0.00402, -0.00407, -0.00413, -0.00416, -0.00424, -0.00429, -0.00435, -0.00437, -0.00446, -0.00451, -0.00458, -0.00465, -0.00471, -0.00476, -0.00483, -0.00489, -0.00496, -0.00502, -0.00510, -0.00507, -0.00524, -0.00532, -0.00542, -0.00548, -0.00556, -0.00567, -0.00575, -0.00585, -0.00595, -0.00605, -0.00616, -0.00625, -0.00626, -0.00638, -0.00651, -0.00666, -0.00671, -0.00664, -0.00696, -0.00686, -0.00726, -0.00703, -0.00752, -0.00765, -0.00781, -0.00800, -0.00828, -0.00838, -0.00868, -0.00859, -0.00913, -0.00942, -0.00954, -0.00987, -0.01020, -0.01043, -0.01083, -0.01100, -0.01151, -0.01191, -0.01232, -0.01275, -0.01331, -0.01367, -0.01425, -0.01486, -0.01559, -0.01613, -0.01691, -0.01779, -0.01779, -0.01779},{  0.00037,  0.00028,  0.00027,  0.00027,  0.00027,  0.00028,  0.00028,  0.00028,  0.00028,  0.00028,  0.00029,  0.00029,  0.00029,  0.00029,  0.00030,  0.00030,  0.00030,  0.00030,  0.00031,  0.00031,  0.00031,  0.00031,  0.00032,  0.00032,  0.00032,  0.00033,  0.00033,  0.00033,  0.00033,  0.00034,  0.00034,  0.00034,  0.00034,  0.00035,  0.00035,  0.00036,  0.00036,  0.00036,  0.00037,  0.00037,  0.00037,  0.00038,  0.00038,  0.00039,  0.00038,  0.00039,  0.00038,  0.00039,  0.00039,  0.00040,  0.00039,  0.00040,  0.00040,  0.00039,  0.00039,  0.00040,  0.00039,  0.00039,  0.00039,  0.00039,  0.00036,  0.00035,  0.00034,  0.00033,  0.00033,  0.00032,  0.00031,  0.00028,  0.00027,  0.00027,  0.00026,  0.00025,  0.00023,  0.00023,  0.00021,  0.00020,  0.00019,  0.00019,  0.00015,  0.00015,  0.00011,  0.00012,  0.00006,  0.00004,  0.00001, -0.00003, -0.00005, -0.00010, -0.00013, -0.00015, -0.00023, -0.00028, -0.00033, -0.00039, -0.00043, -0.00050, -0.00058, -0.00065, -0.00075, -0.00086, -0.00098, -0.00111, -0.00129, -0.00141, -0.00154, -0.00179, -0.00199, -0.00222, -0.00246, -0.00269, -0.00269, -0.00269},{ -0.00028, -0.00016, -0.00015, -0.00014, -0.00013, -0.00013, -0.00013, -0.00012, -0.00012, -0.00012, -0.00012, -0.00011, -0.00011, -0.00011, -0.00011, -0.00011, -0.00010, -0.00010, -0.00010, -0.00009, -0.00009, -0.00009, -0.00008, -0.00008, -0.00007, -0.00007, -0.00006, -0.00006, -0.00005, -0.00004, -0.00004, -0.00003, -0.00002, -0.00002, -0.00001,  0.00000,  0.00000,  0.00001,  0.00002,  0.00003,  0.00003,  0.00004,  0.00005,  0.00005,  0.00006,  0.00007,  0.00008,  0.00008,  0.00008,  0.00008,  0.00009,  0.00009,  0.00009,  0.00008,  0.00008,  0.00009,  0.00008,  0.00007,  0.00006,  0.00005,  0.00003,  0.00001, -0.00001, -0.00004, -0.00006, -0.00009, -0.00010, -0.00012, -0.00015, -0.00017, -0.00018, -0.00019, -0.00021, -0.00022, -0.00023, -0.00025, -0.00026, -0.00027, -0.00029, -0.00030, -0.00031, -0.00033, -0.00034, -0.00035, -0.00037, -0.00038, -0.00040, -0.00041, -0.00042, -0.00044, -0.00044, -0.00046, -0.00047, -0.00048, -0.00048, -0.00049, -0.00050, -0.00051, -0.00051, -0.00052, -0.00051, -0.00051, -0.00052, -0.00052, -0.00052, -0.00051, -0.00050, -0.00050, -0.00049, -0.00048, -0.00048, -0.00048}};
static double _qed_ex[4][112]={{ -0.01183, -0.00131, -0.00025, -0.00004, -0.00001, -0.00003, -0.00013, -0.00024, -0.00041, -0.00051, -0.00067, -0.00078, -0.00094, -0.00103, -0.00118, -0.00127, -0.00140, -0.00156, -0.00160, -0.00167, -0.00182, -0.00191, -0.00201, -0.00207, -0.00216, -0.00221, -0.00228, -0.00231, -0.00241, -0.00245, -0.00254, -0.00263, -0.00267, -0.00274, -0.00276, -0.00280, -0.00286, -0.00291, -0.00295, -0.00298, -0.00303, -0.00309, -0.00311, -0.00313, -0.00319, -0.00324, -0.00327, -0.00328, -0.00336, -0.00341, -0.00344, -0.00351, -0.00353, -0.00356, -0.00359, -0.00365, -0.00367, -0.00370, -0.00373, -0.00367, -0.00379, -0.00385, -0.00389, -0.00394, -0.00396, -0.00400, -0.00405, -0.00408, -0.00411, -0.00417, -0.00422, -0.00427, -0.00432, -0.00436, -0.00441, -0.00447, -0.00453, -0.00445, -0.00466, -0.00449, -0.00478, -0.00459, -0.00492, -0.00500, -0.00502, -0.00510, -0.00523, -0.00527, -0.00539, -0.00533, -0.00561, -0.00575, -0.00590, -0.00599, -0.00610, -0.00618, -0.00632, -0.00642, -0.00662, -0.00682, -0.00702, -0.00719, -0.00737, -0.00763, -0.00780, -0.00800, -0.00826, -0.00848, -0.00875, -0.00896, -0.00896, -0.00896},{ -0.01185, -0.00119, -0.00011,  0.00013,  0.00017,  0.00018,  0.00009, -0.00002, -0.00019, -0.00029, -0.00045, -0.00055, -0.00072, -0.00081, -0.00096, -0.00105, -0.00119, -0.00138, -0.00140, -0.00148, -0.00165, -0.00175, -0.00186, -0.00193, -0.00202, -0.00209, -0.00217, -0.00220, -0.00231, -0.00237, -0.00247, -0.00257, -0.00262, -0.00272, -0.00274, -0.00280, -0.00287, -0.00294, -0.00298, -0.00302, -0.00308, -0.00316, -0.00320, -0.00323, -0.00330, -0.00336, -0.00340, -0.00344, -0.00354, -0.00360, -0.00366, -0.00377, -0.00379, -0.00385, -0.00390, -0.00397, -0.00403, -0.00407, -0.00413, -0.00409, -0.00425, -0.00436, -0.00444, -0.00451, -0.00457, -0.00468, -0.00475, -0.00483, -0.00492, -0.00503, -0.00511, -0.00520, -0.00519, -0.00530, -0.00542, -0.00557, -0.00559, -0.00551, -0.00580, -0.00570, -0.00609, -0.00584, -0.00629, -0.00639, -0.00651, -0.00675, -0.00699, -0.00707, -0.00733, -0.00723, -0.00771, -0.00800, -0.00804, -0.00834, -0.00860, -0.00875, -0.00910, -0.00925, -0.00970, -0.01005, -0.01045, -0.01084, -0.01137, -0.01167, -0.01221, -0.01282, -0.01349, -0.01404, -0.01476, -0.01567, -0.01567, -0.01567},{  0.00021,  0.00020,  0.00021,  0.00021,  0.00021,  0.00021,  0.00021,  0.00021,  0.00022,  0.00022,  0.00023,  0.00023,  0.00024,  0.00024,  0.00025,  0.00025,  0.00026,  0.00027,  0.00027,  0.00027,  0.00028,  0.00028,  0.00029,  0.00029,  0.00030,  0.00030,  0.00031,  0.00031,  0.00032,  0.00033,  0.00033,  0.00034,  0.00034,  0.00035,  0.00036,  0.00036,  0.00037,  0.00038,  0.00038,  0.00039,  0.00039,  0.00040,  0.00040,  0.00041,  0.00041,  0.00042,  0.00042,  0.00043,  0.00043,  0.00044,  0.00044,  0.00045,  0.00045,  0.00045,  0.00045,  0.00046,  0.00046,  0.00046,  0.00046,  0.00047,  0.00045,  0.00044,  0.00044,  0.00043,  0.00044,  0.00043,  0.00042,  0.00040,  0.00039,  0.00040,  0.00039,  0.00039,  0.00037,  0.00038,  0.00037,  0.00036,  0.00036,  0.00037,  0.00034,  0.00034,  0.00031,  0.00033,  0.00028,  0.00027,  0.00025,  0.00022,  0.00021,  0.00017,  0.00015,  0.00015,  0.00008,  0.00004,  0.00002, -0.00003, -0.00005, -0.00009, -0.00015, -0.00019, -0.00026, -0.00034, -0.00044, -0.00053, -0.00068, -0.00076, -0.00085, -0.00107, -0.00121, -0.00141, -0.00159, -0.00179, -0.00179, -0.00179},{ -0.00044, -0.00024, -0.00021, -0.00021, -0.00020, -0.00020, -0.00020, -0.00019, -0.00018, -0.00018, -0.00018, -0.00018, -0.00017, -0.00017, -0.00016, -0.00016, -0.00015, -0.00015, -0.00014, -0.00014, -0.00013, -0.00013, -0.00012, -0.00011, -0.00011, -0.00010, -0.00009, -0.00009, -0.00008, -0.00007, -0.00007, -0.00005, -0.00004, -0.00004, -0.00003, -0.00002, -0.00002, -0.00000,  0.00001,  0.00002,  0.00002,  0.00004,  0.00005,  0.00005,  0.00006,  0.00006,  0.00007,  0.00008,  0.00008,  0.00008,  0.00009,  0.00009,  0.00010,  0.00009,  0.00009,  0.00009,  0.00009,  0.00008,  0.00007,  0.00006,  0.00005,  0.00003,  0.00000, -0.00002, -0.00004, -0.00007, -0.00008, -0.00010, -0.00013, -0.00014, -0.00016, -0.00016, -0.00018, -0.00019, -0.00020, -0.00022, -0.00022, -0.00024, -0.00025, -0.00026, -0.00028, -0.00029, -0.00031, -0.00031, -0.00032, -0.00034, -0.00036, -0.00037, -0.00038, -0.00039, -0.00040, -0.00041, -0.00042, -0.00043, -0.00043, -0.00044, -0.00045, -0.00046, -0.00045, -0.00046, -0.00045, -0.00045, -0.00046, -0.00046, -0.00046, -0.00045, -0.00043, -0.00043, -0.00042, -0.00041, -0.00041, -0.00041}};
static double _qed_rec[4][112]={{  0.00297,  0.00135,  0.00109,  0.00108,  0.00107,  0.00114,  0.00111,  0.00108,  0.00100,  0.00103,  0.00098,  0.00100,  0.00095,  0.00097,  0.00093,  0.00095,  0.00091,  0.00083,  0.00089,  0.00090,  0.00083,  0.00081,  0.00079,  0.00080,  0.00078,  0.00079,  0.00078,  0.00081,  0.00077,  0.00078,  0.00074,  0.00071,  0.00072,  0.00069,  0.00072,  0.00069,  0.00070,  0.00069,  0.00070,  0.00071,  0.00070,  0.00068,  0.00069,  0.00068,  0.00069,  0.00068,  0.00069,  0.00067,  0.00067,  0.00066,  0.00066,  0.00063,  0.00066,  0.00065,  0.00065,  0.00064,  0.00065,  0.00066,  0.00067,  0.00068,  0.00068,  0.00066,  0.00067,  0.00066,  0.00067,  0.00067,  0.00067,  0.00068,  0.00068,  0.00068,  0.00069,  0.00068,  0.00070,  0.00070,  0.00070,  0.00070,  0.00071,  0.00072,  0.00073,  0.00073,  0.00073,  0.00074,  0.00076,  0.00078,  0.00079,  0.00076,  0.00078,  0.00079,  0.00080,  0.00080,  0.00083,  0.00083,  0.00085,  0.00088,  0.00092,  0.00093,  0.00095,  0.00093,  0.00090,  0.00098,  0.00097,  0.00099,  0.00100,  0.00104,  0.00107,  0.00108,  0.00114,  0.00116,  0.00123,  0.00126, 0.00126, 0.00126},{  0.00331,  0.00154,  0.00126,  0.00126,  0.00125,  0.00134,  0.00131,  0.00128,  0.00119,  0.00124,  0.00117,  0.00121,  0.00115,  0.00118,  0.00113,  0.00116,  0.00111,  0.00102,  0.00110,  0.00112,  0.00104,  0.00101,  0.00099,  0.00101,  0.00099,  0.00100,  0.00099,  0.00104,  0.00098,  0.00100,  0.00095,  0.00092,  0.00093,  0.00090,  0.00094,  0.00091,  0.00092,  0.00091,  0.00093,  0.00094,  0.00094,  0.00091,  0.00093,  0.00092,  0.00094,  0.00093,  0.00095,  0.00093,  0.00093,  0.00091,  0.00092,  0.00088,  0.00092,  0.00091,  0.00093,  0.00091,  0.00093,  0.00095,  0.00096,  0.00098,  0.00098,  0.00096,  0.00098,  0.00097,  0.00099,  0.00100,  0.00100,  0.00102,  0.00103,  0.00103,  0.00105,  0.00105,  0.00107,  0.00109,  0.00110,  0.00110,  0.00112,  0.00113,  0.00116,  0.00116,  0.00118,  0.00120,  0.00123,  0.00126,  0.00130,  0.00126,  0.00129,  0.00131,  0.00135,  0.00136,  0.00142,  0.00142,  0.00150,  0.00153,  0.00161,  0.00167,  0.00172,  0.00175,  0.00181,  0.00186,  0.00188,  0.00192,  0.00194,  0.00200,  0.00204,  0.00204,  0.00210,  0.00209,  0.00215,  0.00212, 0.00212, 0.00212},{ -0.00016, -0.00008, -0.00007, -0.00007, -0.00007, -0.00007, -0.00007, -0.00007, -0.00006, -0.00006, -0.00006, -0.00006, -0.00005, -0.00005, -0.00005, -0.00005, -0.00004, -0.00004, -0.00004, -0.00004, -0.00003, -0.00003, -0.00003, -0.00003, -0.00002, -0.00002, -0.00002, -0.00002, -0.00001, -0.00001, -0.00001, -0.00001, -0.00000,  0.00000,  0.00000,  0.00001,  0.00001,  0.00001,  0.00001,  0.00002,  0.00002,  0.00002,  0.00003,  0.00003,  0.00003,  0.00003,  0.00004,  0.00004,  0.00004,  0.00004,  0.00005,  0.00005,  0.00005,  0.00006,  0.00006,  0.00006,  0.00007,  0.00007,  0.00008,  0.00008,  0.00009,  0.00009,  0.00009,  0.00010,  0.00010,  0.00011,  0.00011,  0.00012,  0.00012,  0.00013,  0.00013,  0.00014,  0.00014,  0.00015,  0.00016,  0.00016,  0.00017,  0.00018,  0.00019,  0.00019,  0.00020,  0.00021,  0.00022,  0.00023,  0.00024,  0.00024,  0.00026,  0.00027,  0.00028,  0.00029,  0.00031,  0.00032,  0.00034,  0.00035,  0.00038,  0.00041,  0.00042,  0.00046,  0.00049,  0.00052,  0.00054,  0.00058,  0.00061,  0.00065,  0.00069,  0.00072,  0.00078,  0.00081,  0.00087,  0.00091, 0.00091, 0.00091},{ -0.00016, -0.00008, -0.00007, -0.00007, -0.00007, -0.00007, -0.00007, -0.00007, -0.00006, -0.00006, -0.00006, -0.00006, -0.00006, -0.00006, -0.00005, -0.00005, -0.00005, -0.00005, -0.00005, -0.00005, -0.00004, -0.00004, -0.00004, -0.00004, -0.00003, -0.00003, -0.00003, -0.00003, -0.00003, -0.00003, -0.00003, -0.00002, -0.00002, -0.00002, -0.00002, -0.00002, -0.00002, -0.00002, -0.00001, -0.00001, -0.00001, -0.00001, -0.00001, -0.00001, -0.00001, -0.00000, -0.00000, -0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00001,  0.00001,  0.00001,  0.00001,  0.00001,  0.00001,  0.00001,  0.00001,  0.00002,  0.00002,  0.00002,  0.00002,  0.00002,  0.00002,  0.00002,  0.00002,  0.00002,  0.00003,  0.00003,  0.00003,  0.00003,  0.00003,  0.00003,  0.00003,  0.00003,  0.00003,  0.00004,  0.00004,  0.00004,  0.00004,  0.00004,  0.00004,  0.00004,  0.00004,  0.00004,  0.00004,  0.00005,  0.00005,  0.00005,  0.00005,  0.00005,  0.00005,  0.00005,  0.00005,  0.00005,  0.00005,  0.00006,  0.00006,  0.00006,  0.00006,  0.00006,  0.00006,  0.00006,  0.00006,  0.00007,  0.00007,  0.00007,  0.00007, 0.00007, 0.00007}};

static double _bethe[36] =
  {2.9841285,2.8117699,-0.0300167,2.7676636,-0.0381902,-0.0052321,
   2.7498118,-0.0419549,-0.0067409,-0.0017337,2.7408237,-0.0440347,
  -0.0076008,-0.0022022,-0.0007721,2.7356642,-0.0453122,-0.0081472,
  -0.0025022,-0.0009628,-0.0004079,2.7324291,-0.0461552,-0.0085192,
  -0.0027091,-0.0010945,-0.0004997,-0.0002409,2.7302673,-0.0467413,
  -0.0087850,-0.0028591,-0.0011904,-0.0005665,-0.0002904,-0.0001539};

/*   The function  F (Z*\alpha)  is estimated here. We use the series      
     expansion given by  Eqs (1) and (2) and the table of Bethe loga-   
     rithms in  S Klarsfeld and A Maquet, Physics Letters  43B (1973)   
     201. */
double Klamaq(int n, int k){
  double c401 = 11.0/24.0;
  double c402 = 3.0/8.0;
  double ovlfac = 4.0/3.0;

  int l,loc;
  double bethel;
  double term;
  double r;
  
  if (k > 0) l = k;   
  else l = -k-1;

  loc = (n*n-n)/2+l+1;  
  bethel = _bethe[loc-1];

  term = -bethel;
  
  if (k > 0) term = term-c402/(l*(l+l+1));
  else term = term+c402/((l+1)*(l+l+1));

  r = ovlfac*term;
  return r;
}

double NucleusRRMS(double z) {
  int id, t, np, nx;
  double rr;
  
  id = ((int)(0.5+z))-1;
  if (id >= 0 && id < 110 && fabs(z-id-1)<1e-5) {
    rr = _qed_rrms[id];
  } else {
    t = 1;
    np = 3;
    nx = 112;
    UVIP3P(np, nx, _qed_za, _qed_rrms, t, &z, &rr);
  }
  return rr;
}

double HydrogenicSelfEnergy(int md0, int pse, double scl, POTENTIAL *pot,
			    ORBITAL *orb, ORBITAL *orbp) {
  int id, np = 3, nx = 12, m = 1, t, n, k, kl, md, mp, mm, md1;
  double r, r0, a, b, c, c2, p, rms, z, cr, ch, rr;

  n= orb->n;
  k = orb->kappa;
  z = pot->Z[pot->maxrp-1];
  if (orbp == NULL) {
    orbp = orb;
  } else if (orbp->kappa != k) {
    return 0.0;
  }
  mp = pot->pse;
  mm = md0/100;
  md0 = md0%100;
  md = md0/10;
  md1 = md0%10;
  if (md1 == 2 && orbp->n == n) {
    if (md == 4 || md == 6) {
      md = 0;
    } else if (md == 5 || md == 7) {
      md = 3;
    }
  }
  r = 0.0;
  rr = 0.0;
  rms = 0.0;
  if (md != 2) {
    kl = GetLFromKappa(k)/2;
    if (orbp->n != n) {
      if (md >= 6 && z >= 10 && z <= 120 && kl <= 2) {
	if (orb->energy > orbp->energy) {
	  GENQED(orbp->n, n, k, mp, pot->maxrp, pot->mqrho,
		 orbp->wfun, orbp->wfun+pot->maxrp,
		 orb->wfun, orb->wfun+pot->maxrp, &r);
	} else {
	  GENQED(n, orbp->n, k, mp, pot->maxrp, pot->mqrho,
		 orb->wfun, orb->wfun+pot->maxrp,
		 orbp->wfun, orbp->wfun+pot->maxrp, &r);
	}
	if(pse) {
	  MPrintf(-1, "SE: %g %d %d %2d %2d %d %11.4E %11.4E %11.4E %11.4E %11.4E\n",
		  z, n, orbp->n, k, md0, mp, orb->energy, orbp->energy, orb->qed, orbp->qed, r);
	}
	return r;
      }
      return 0.0;
    }
    rms = pot->atom->rms*RBOHR*1e5;
    cr = 0;
    ch = 0;
    r = 0;
    rr = 0;
    if (md >= 4 && z >= 10 && z <= 120 && kl <= 2) {
      GENQED(n, n, k, mp, pot->maxrp, pot->mqrho,
	     orb->wfun, orb->wfun+pot->maxrp,
	     orb->wfun, orb->wfun+pot->maxrp, &r);
      if (r) {
	r /= scl;
      }
    } else {
      mp = 0;
    }
    if (!r && n <= 2 && mp == 0) {
      if (md == 1 && z >= 26 && k != -2) {
	MOHRFIN(n, k, z, rms, &r, &a, &b, &c, &p);
      }
      if (!r) {
	id = ((int)(0.5+z))-1;
	if (n == 1) m = 0;
	else if (k == -1) m = 1;
	else if (k == 1) m = 2;
	else m = 3;
	if (id >= 0 && id < 110 && fabs(z-id-1) < 1e-5) {
	  if (rms <= 0) {
	    r = _qed_se0[m][id];
	  } else {
	    r = _qed_se0[m][id] + _qed_se1[m][id];	    
	    rr = _qed_rrms[id];
	    if (z >= 26 && fabs(rms-rr) > 1e-6*rr) {
	      MOHRFIN(-n, k, z, rms, &c2, &a, &b, &c, &p);
	      cr = a*(pow(rms,p)*(1+b*rms+c*rms*rms)-pow(rr,p)*(1+b*rr+c*rr*rr));
	      r += cr;
	    }	    
	  }
	} else {
	  t = 1;
	  nx = 112;
	  if (rms <= 0) {
	    UVIP3P(np, nx, _qed_za, _qed_se0[m], t, &z, &r);
	  } else {
	    UVIP3P(np, nx, _qed_za, _qed_se0[m], t, &z, &r);
	    UVIP3P(np, nx, _qed_za, _qed_se1[m], t, &z, &r0);
	    r += r0;	    
	    UVIP3P(np, nx, _qed_za, _qed_rrms, t, &z, &rr);
	    if (z >= 26 && fabs(rms-rr) > 1e-6*rr) {
	      MOHRFIN(-n, k, z, rms, &c2, &a, &b, &c, &p);
	      cr = a*(pow(rms,p)*(1+b*rms+c*rms*rms)-pow(rr,p)*(1+b*rr+c*rr*rr));
	      r += cr;
	    }	    
	  }
	}
      }
    }
    if (!r && mp == 0) {
      if (n <= 5) {
	id = _nd[n-1];
	switch (k) {
	case -1:
	  break;
	case 1:
	  id += 1;
	  break;
	case -2:
	  id += 2;
	  break;
	case 2:
	  id += 3;
	  break;
	case -3:
	  id += 4;
	  break;
	default:
	  id = -1;
	  break;
	}
      } else {
	id = -1;
      }
      if (id >= 0) {
	m = 1;
	nx = 14;
	UVIP3P(np, nx, _zd, _sd[id], m, &z, &r);
      } else {
	r = Klamaq(n, k);
      }
      if (rms > 0 && z >= 10 && z <= 120 && kl <= 2 && n > 2) {
	m = (int)z;
	a = 0;
	b = 0;
	FSEDAT(k, n, n, z, &a, &b);
	if (a && b) {
	  r += b-a;
	}
      }
    }
  }
  
  if (n <= 2 && md != 3 && md != 5 && md != 7) {
    double *qex[4];
    if (md != 2) {
      if (mm < 3) {
	for (t = 0; t < 4; t++) {
	  qex[t] = _qed_ex0[t];
	}
      } else {
	for (t = 0; t < 4; t++) {
	  qex[t] = _qed_ex[t];
	}
      }
    } else if (mm == 3) {
      for (t = 0; t < 4; t++) {
	qex[t] = _qed_rec[t];
      }
    } else {
      return 0.0;
    }
    id = ((int)(z+0.5))-1;
    if (id >= 0 && id < 110 && fabs(z-id-1) < 1e-5) {
      if (n == 1) ch = qex[0][id];
      else if (n == 2) {
	if (k == -1) ch = qex[1][id];
	else if (k == 1) ch = qex[2][id];
	else if (k == -2) ch= qex[3][id];
      }
    } else {
      t = 1;
      nx = 112;
      if (n == 1) {
	UVIP3P(np, nx, _qed_za, qex[0], t, &z, &ch);
      } else if (n == 2) {
	if (k == -1) {
	  UVIP3P(np, nx, _qed_za, qex[1], t, &z, &ch);
	} else if (k == 1) {
	  UVIP3P(np, nx, _qed_za, qex[2], t, &z, &ch);
	} else if (k == -2) {
	  UVIP3P(np, nx, _qed_za, qex[3], t, &z, &ch);
	}
      }
    }
    r += ch;    
  }
  c = FINE_STRUCTURE_CONST*z;
  c2 = c*c;
  c = c2*c2;
  c /= PI*n*n*n*FINE_STRUCTURE_CONST;
  r0 = r*c;
  a = r0*scl;
  if (pse) {
    MPrintf(-1, "SE: %g %d %2d %11.4E %2d %d %.4f %.4f %.6f %11.4E %11.4E %11.4E %11.4E %11.4E %11.4E\n", z, n, k, orb->energy, md0, mp, rr, rms, scl, r, cr, ch, c, r0, a);
  }
  return a;
}

double CoulombPhaseShift(double z, double e, int kappa) {
  double phase, r, y, ke, a, b1, b2;

  a = FINE_STRUCTURE_CONST2 * e;
  ke = sqrt(2.0*e*(1.0 + 0.5*a));
  a += 1.0;
  y = a*z/ke;

  r = kappa;
  b1 = y/(fabs(r)*a);
  r = sqrt(r*r - FINE_STRUCTURE_CONST2*z*z);
  b2 = y/r;

  if (kappa < 0) {
    phase = 0.5*(atan(b1) - atan(b2));
  } else {
    phase = -0.5*(atan(b1) + atan(b2) + PI);
  }

  phase -= ARGAM(r, y);
  phase += (1.0 - r)*0.5*PI;

  return phase;
}

double *GetCoulombBethe(int ie2, int ite, int ie1, int t, int q) {
  return _cb[ie2][ite][ie1][_cbindex[t-1][q]];
}

double GetCoulombBetheAsymptotic(double te, double e1) {
  double r;

  r = e1/(e1+te);
  r = r/(1.0-r);
  
  return r;
}

void PrepCBIndex(void) {
  int t, q, i;

  i = 0;
  for (t = 1; t <= CBMULT; t++) {
    for (q = 0; q <= t; q++) {
      _cbindex[t-1][q] = i;
      i++;
    }
  }
}

/* calculates the Coulomb Bethe contributions from L to Inf. */
int CoulombBetheTail(int n, double *w3, int nkl, double *kl, double *tcb) {
  double r, a, b, tn;
  int i, j, k, p;

  i = n-1;
  r = w3[i];
  tn = r/(1.0-r);
  for (j = nkl - 1; j > 0; j--) {
    k = kl[j];
    if (k >= i) {
      tcb[j] = tn;
    } else {
      a = 1.0;
      b = 0.0;
      for (p = k; p < i; p++) {
	a *= w3[p];
	b += a;
      }
      b += a*tn;
      tcb[j] = b;
      tn = b;
      i = k;
    }
  }
  return 0;
}

double PartialOmegaMSub(int k1, double *r, int k, int m, double z, double e) {
  int k0, k0p, m0, j0, j0p, j1, i, ip, k1m;
  int km, m2, k0m, k0pm, kappa0, kappa0p;
  double p0, p0p, a, w1, w2, w3, w4, w5, w6, x;

  km = k*2;
  m2 = m*2;
  x = 0.0;
  for (i = 0; i <= k; i++) {
    k0 = k1 + 2*i - k;
    k0m = k0*2;    
    for (j0 = k0m - 1; j0 <= k0m + 1; j0 += 2) {
      kappa0 = GetKappaFromJL(j0, k0m);
      p0 = CoulombPhaseShift(z, e, kappa0);
      for (ip = 0; ip <= k; ip++) {
	k0p = k1 + 2*ip - k;
	k0pm = k0p*2;
	for (j0p = k0pm - 1; j0p <= k0pm + 1; j0p += 2) {
	  kappa0p = GetKappaFromJL(j0p, k0pm);
	  p0p = CoulombPhaseShift(z, e, kappa0p);	  
	  a = sqrt((k0m+1.0)*(k0pm+1.0)*(j0+1.0)*(j0p+1.0))*cos(p0p-p0);
	  k1m = k1*2;
	  for (j1 = k1m - 1; j1 <= k1m + 1; j1 += 2) {
	    w5 = ReducedCL(j0, km, j1);
	    w6 = ReducedCL(j0p, km, j1);
	    for (m0 = -1; m0 <= 1; m0 += 2) {
	      w1 = W3j(j0, 1, k0m, -m0, m0, 0);
	      w2 = W3j(j0p, 1, k0pm, -m0, m0, 0);
	      w3 = W3j(j0, km, j1, -m0, -m2, m0+m2);
	      w4 = W3j(j0p, km, j1, -m0, -m2, m0+m2);
	      x += w1*w2*w3*w4*w5*w6*a*r[i]*r[ip];
	    }
	  }
	}
      }
    }
  }

  return x;
}

double PartialOmega(int k0, double *r, int k) {
  int i, k1, g, g2, i0, i1, i2, i3;
  double a, b, c, x;

  x = 0.0;
  for (i = 0; i <= k; i++) {
    k1 = k0 + i*2 - k;
    a = 2.0*(2.0*k0+1.0)*(2.0*k1+1.0);
    g2 = k0 + k1 + k;
    g = g2/2;
    i0 = g2 - 2*k0;
    i1 = g2 - 2*k1;
    i2 = g2 - 2*k;
    if (i2 < 0) i2 = 0;
    i3 = g2 + 1;
    b = LnFactorial(i0)+LnFactorial(i1)+LnFactorial(i2)-LnFactorial(i3);
    i0 = g - k0;
    i1 = g - k1;
    i2 = g - k;
    if (i2 < 0) i2 = 0;
    c = LnFactorial(g)-LnFactorial(i0)-LnFactorial(i1)-LnFactorial(i2);
    b += 2.0*c;
    b = exp(b);
    x += a*b*r[i]*r[i];
  }

  return x;
}

int PrepCoulombBethe(int ne2, int nte, int ne1, double z,
		     double *e2, double *te, double *e1,
		     int nkl, double *kl, int mode) {
  int i, ie1, ie2, ite, i1, k, m, ik, ierr, q0, q1;
  int t1, ik2, mq;
  double ee1, ee0, k0, k1, k0s, k1s, a, b, r0, r1;
  double w2, w3, *wr, *ws, *wt, *w, *tcb, *r[CBMULT];
  
  if (ne2 > MAXNE || ne1 > MAXNE || nte > MAXNTE) {
    printf("Array multipoles not large enough in CoulombMultipoles\n");
    exit(1);
  }
  
  for (i = 0; i < CBMULT; i++) {
    r[i] = malloc(sizeof(double)*(i+2)*(CBLMAX+1));
  }
  for (ie2 = 0; ie2 < MAXNE; ie2++) {
    for (ite = 0; ite < MAXNTE; ite++) {
      for (ie1 = 0; ie1 < MAXNE; ie1++) {
	for (i = 0; i < MAXNCB; i++) {
	  free(_cb[ie2][ite][ie1][i]);
	  _cb[ie2][ite][ie1][i] = malloc(sizeof(double)*nkl);
	}
      }
    }
  }
  
  w = malloc(sizeof(double)*(CBLMAX+1));
  wt = malloc(sizeof(double)*(CBLMAX+1));
  ws = malloc(sizeof(double)*(CBLMAX+1));
  wr = malloc(sizeof(double)*nkl);
  for (ie1 = 0; ie1 < ne1; ie1++) {
    ee1 = e1[ie1];
    k1s = 2.0*ee1;
    k1 = sqrt(k1s);
    for (ie2 = 0; ie2 < ne2; ie2++) {
      for (ite = 0; ite < nte; ite++) {
	ee0 = ee1 + e2[ie2] + te[ite];
	k0s = 2.0*ee0;
	k0 = sqrt(k0s);
	a = ee1/ee0;
	b = -log(10.0)/log(a);
	q0 = 3.0*b;
	q1 = 7.0*b;
	if (q0 > CBLMIN) q0 = CBLMIN;
	if (q1 > CBLMAX) q1 = CBLMAX;
	if (a < 0.6 || q1 <= q0) {
	  a = a/(1-a);
	  for (i = 0; i < MAXNCB; i++) {
	    for (m = 0; m < nkl; m++) {
	      _cb[ie2][ite][ie1][i][m] = a;
	    }
	  }
	  continue;
	}
	if (q0 > 1) {
	  r0 = 0.5*(sqrt(z*z+2.0*q0*(q0+1.0)*ee0)-z)/(2.0*ee0);
	} else {
	  r0 = 0.1/z;
	}
	r1 = -1.0;
	for (i = 0; i < CBMULT; i++) {
	  i1 = i + 1;
	  if (mode == 0) {
	    CMULTIP(r0, r1, z, k0, k1, i1, q0, q1, 
		    r[i], 1, &ierr);
	  } else {
	    CMULTIP(r0, r1, z, k1, k0, i1, q0, q1, 
		    r[i], 1, &ierr);
	  }
	  for (k = q0; k <= q1; k++) {
	    ik = k - q0;
	    ik2 = ik*(i+2);
	    wt[k] = PartialOmega(k, r[i]+ik2, i1);
	    if (k > q0) {
	      w[k-1] = wt[k]/wt[k-1];
	      if (wt[k]/wt[q0] < EPS6) {
		k++;
		break;
	      }
	    }
	    if (i1 == 1) {
	      if (r[i][ik2] < 0 || r[i][ik2+1] < 0) 
		break;
	    }
	  }
	  if (i1 == 1) {
	    q1 = k-1;
	    if (q1 <= q0) {
	      a = ee1/(ee0 - ee1);
	      for (i = 0; i < MAXNCB; i++) {
		for (m = 0; m < nkl; m++) {
		  _cb[ie2][ite][ie1][i][m] = a;
		}
	      }
	      goto NEXTE;
	    }
	    for (k = q0; k < q1; k++) {
	      ik = k - q0;
	      ik2 = ik*2;
	      w3 = r[i][ik2+2]/r[i][ik2];
	      w2 = r[i][ik2+1]/r[i][ik2];
	      w3 *= w3;
	      w2 *= w2;
	      if (mode == 0) {
		a = z*z + (k+1.0)*(k+1.0)*k0s;
		a *= w3-w2;
	      } else {
		a = z*z + (k+1.0)*(k+1.0)*k1s;
		a *= w2 - w3;
	      }
	      b = k + (k+1.0)*w2;
	      b *= (k+1.0)*2.0*(te[ite]+e2[ie2]);
	      ws[k] = a/b;
	    }
	    if (mode == 0) {
	      tcb = GetCoulombBethe(ie2, ite, ie1, i1, 0);
	      for (m = 0; m < nkl; m++) {
		k = (int) kl[m];
		if (k >= q1) {
		  tcb[m] = ws[q1-1];
		} else if (k < q0) {
		  tcb[m] = ws[q0];
		} else {
		  tcb[m] = ws[k];
		}
	      }
	    }
	    k = q1;
	  }
	  for (; k <= CBLMAX; k++) {
	    w[k-1] = w[k-2];
	  }
	  w[k-1] = w[k-2];
	  for (k = 0; k < q0; k++) {
	    w[k] = w[q0];
	  }
	  if (mode == 0) {
	    if (i1 > 1) {
	      tcb = GetCoulombBethe(ie2, ite, ie1, i1, 0);
	      CoulombBetheTail(CBLMAX+1, w, nkl, kl, tcb);
	    }
	  } else if (i1 == 1) {
	    CoulombBetheTail(CBLMAX+1, w, nkl, kl, wr);
	    for (m = 0; m < nkl; m++) {
	      k = (int) kl[m];
	      if (k < q0) {
		wr[m] = ws[q0]/wr[m];
	      } else if (k > q1) {
		wr[m] = ws[q1-1]/wr[m];
	      } else {
		wr[m] = ws[k]/wr[m];
	      }
	    }
	  }
	}
	if (mode) {
	  for (t1 = 0; t1 < CBMULT; t1++) {
	    for (mq = 0; mq <= t1+1; mq++) {
	      for (k = q0; k <= q1; k++) {		  
		ik = k - q0;
		ik2 = ik*(t1+2);
		wt[k] = PartialOmegaMSub(k, r[t1]+ik2, t1+1, mq, z, ee0);
		if (k > q0) w[k-1] = wt[k]/wt[k-1];
	      }		
	      for (; k <= CBLMAX; k++) {
		w[k-1] = w[k-2];
	      }
	      w[k-1] = w[k-2];
	      for (k = 0; k < q0; k++) {
		w[k] = w[q0];
	      }
	      tcb = GetCoulombBethe(ie2, ite, ie1, t1+1, mq);
	      CoulombBetheTail(CBLMAX+1, w, nkl, kl, tcb);
	      if (t1 == 0) {
		for (m = 0; m < nkl; m++) {
		  tcb[m] *= wr[m];
		}
	      }
	    }
	  }
	}
      NEXTE:
	continue;
      }
    }
  }
	
  for (i = 0; i < CBMULT; i++) {
    free(r[i]);
  }
  free(w);
  free(wt);
  free(ws);
  free(wr);

  return 0;
}

int CoulombBethe(char *s, double z, double te, double e1) {
#define M 200
  double kl[M];
  int i, j, k, m;
  FILE *f;
  int nte, ne1, ne2, ie1, ite;
  double e2, *tcb;
  
  ne2 = 1;
  ne1 = 1;
  nte = 1;
  e2 = 0.0;
  f = fopen(s, "w");
  fprintf(f, "## TE = %10.3E, E1 = %10.3E\n", te, e1);

  te /= HARTREE_EV;
  e1 /= HARTREE_EV;
  for (i = 0; i < M; i++) {
    kl[i] = i;
  }

  PrepCoulombBethe(ne2, nte, ne1, z, &e2, &te, &e1, M, kl, 1);
  for (i = 1; i < M; i++) {
    fprintf(f, "%3d %3d ", i, (int)kl[i]);
    for (j = 0; j < CBMULT; j++) {
      for (m = 0; m <= j+1; m++) {
	tcb = GetCoulombBethe(0, 0, 0, j+1, m);
	fprintf(f, "%12.5E ", tcb[i]);
      }
    }
    fprintf(f, "\n");
  }

  fclose(f);

  return 0;
#undef M
}

int CoulombMultip(char *fn, double z, double te, double e1,
		   int k, int q0, int q1, int m) {
  FILE *f;
  double *r, r0, r1, k0, k1;
  int i, j, ierr;

  k1 = sqrt(2.0*e1/HARTREE_EV);
  k0 = sqrt(2.0*(e1+te)/HARTREE_EV);

  r0 = 0.1/z;
  r1 = -1.0;
  r = (double *) malloc(sizeof(double)*(k+1)*(q1-q0+1));
  CMULTIP(r0, r1, z, k0, k1, k, q0, q1, r, m, &ierr);
  if (ierr != 0) {
    printf("error in CMULTIP: %d\n", ierr);
    free(r);
    return -1;
  }
  f = fopen(fn, "w");
  fprintf(f, "# %10.3E %10.3E %10.3E %15.8E %15.8E %2d\n",
	  z, te, e1, k0, k1, k);
  j = 0;
  for (m = q0; m <= q1; m++) {
    fprintf(f, "%4d", m);
    for (i = -k; i <= k; i += 2) {
      fprintf(f, " %17.10E", r[j]);
      j++;
    }
    fprintf(f, "\n");
  }
  fclose(f);
  free(r);
  
  return 0;
}

int InitCoulomb(void) {
  int i, ie1, ie2, ite;

  for (ie2 = 0; ie2 < MAXNE; ie2++) {
    for (ite = 0; ite < MAXNTE; ite++) {
      for (ie1 = 0; ie1 < MAXNE; ie1++) {
	for (i = 0; i < MAXNCB; i++) {
	  _cb[ie2][ite][ie1][i] = NULL;
	}
      }
    }
  }
  PrepCBIndex();
  SetHydrogenicNL(-1, -1, -1, -1);

  dipole_array = (ARRAY *) malloc(sizeof(ARRAY));
  ArrayInit(dipole_array, sizeof(double *), DIPOLE_BLOCK);

  return 0;
}
